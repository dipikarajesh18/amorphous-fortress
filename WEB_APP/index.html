<html>
    <head>
        <title>Amorphous Fortress - Entity Editor</title> 
        <link rel="stylesheet" href="app_style.css">
        <!-- ADD STYLES TO SHEET WHEN FINISHED -->
        <style>
            

        </style>
    </head>
    <body onload="init()">
        <div id="title">
            Amorphous Fortress - Entity Editor
        </div>
        <div id="container">
            <!-- TOP BAR MENU w/ DROPDOWN -->

            <!-- TODO: Make the submenu disappear after a selection -->

            <div id="menu">
                <div class="menu-item">File
                    <div id='file_menu' class="menu-dropdown">
                        <div class="menudrop-item" onclick="newGraph();">New</div>
                        <div class="menudrop-item" onclick="document.getElementById('entFileIn').click();">Open</div>
                            <input type="file" id="entFileIn" style="display: none;" accept=".txt" onchange="readEntFile();"/>
                        <!-- <div class="menudrop-item">Save</div> -->
                        <div class="menudrop-item" onclick="exportEntGraph();">Save As</div>
                    </div>
                </div>
                

                <div class="menu-item">Graph
                    <div id='edit_menu' class="menu-dropdown">
                        <div class="menudrop-item" onclick="orderGraph();">Organize Graph</div>
                        <div class="menudrop-item" onclick="showConfigEditor();">Edit Config</div>
                        <!-- <div class="menudrop-item">New Node</div>
                        <div class="menudrop-item">New Edge</div>
                        <div class="menudrop-item">Delete Node</div>
                        <div class="menudrop-item">Delete Edge</div> -->
                    </div>
                </div>


                <!-- <div class="menu-item">View
                    <div id='view_menu' class="menu-dropdown">
                        <div class="menudrop-item">Zoom In</div>
                        <div class="menudrop-item">Zoom Out</div>
                        <div class="menudrop-item">Zoom Reset</div>
                        <div class="menudrop-item">Toggle Grid Snap</div>
                        <div class="menudrop-item">Clean Up Graph</div>
                    </div>
                </div> -->


                <div class="menu-item">Help
                    <div id='help_menu' class="menu-dropdown">
                        <div class="menudrop-item">About</div>
                        <div class="menudrop-item">Quick Start</div>
                        <div class="menudrop-item">Documentation</div>
                        <div class="menudrop-item">Report Bug</div>
                    </div>
                </div>

                <!-- FOR DEBUGGNG -->
                <!-- <div id="magic-button" onclick="">Magic Button</div> -->

            </div>

            <!-- GRAPH NODE EDITOR CANVAS -->
            <div id="gfx-editor">
                <canvas id="graph-canvas" width="625" height="615"></canvas>
                <div id="alter-dropdown">
                    <div id="alter-title">NODES</div>
                    <div id="alter-content">
                        <div class="alter-item" onclick="changeNode('take');">take</div>
                        <div class="alter-item" onclick="changeNode('clone');">clone</div>
                        <div class="alter-item" onclick="changeNode('transform');">transform</div>
                        <div class="alter-item" onclick="changeNode('-');">-</div>
                    </div>
                </div>
            </div>

            <!-- GRAPH CONFIGURATION EDITOR -->
            <div id="config-editor">
                <div id="config-window">
                    <div id="config-header">
                        CONFIG EDITOR
                        <div id="config-exit" onclick="showGraphEditor();">X</div>
                    </div>
                    <div id="config-content">
                        <div id="config-node_set" class="config-split">
                            <div class="config-title">NODES</div>
                        </div>
                        <div id="config-edge_set" class="config-split">
                            <div class="config-title">EDGES</div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- SIDE BAR TEXT EDITOR -->
            <div id="txt-editor">
                <!-- name -->
                <div id="entity-name">
                    <div id="char_div">
                        <input type="text" id="char_in" maxlength="1" placeholder="?" value="@"/>
                        <div id="char_txt"></div>
                    </div>
                    <div id="name_div">
                        <input type="text" id="name_in" placeholder="entity_name" value="Link"/>
                        <div id="name_txt"></div>
                    </div>
                </div>

                <!-- nodes -->
                <div id="entity-nodes">
                    <div class="txt-title">
                        <div class="ent-add-btn" onclick="addNode()">+</div>
                        NODES
                        <div class="ent-del-btn" onclick="deleteCurSelect('node')">-</div>
                    </div>
                    <div id="node-list">
                        
                    </div>
                </div>

                <!-- edges -->
                <div id="entity-edges">
                    <div class="txt-title">
                        <div class="ent-add-btn" onclick="promptAddNode()">+</div>
                        EDGES
                        <div class="ent-del-btn" onclick="deleteCurSelect('edge')">-</div>
                    </div>
                    <div id="edge-list">
                        
                    </div>
                </div>
            </div>
        </div>




        <!-- SCRIPTS -->
        <script src="js/global_ui.js"></script>
        <script src="js/text_ui.js"></script>
        <script src="js/graph_ui.js"></script>



        <!-- REMOVE THESE SCRIPTS OR PUT THEM SOMEWHERE ELSE - PURELY FOR TEST PURPOSES -->
        <!-- DEBUG -->
        <div id="debug"><< DEBUG HERE >></div>
        <div id="keycode-debug">
            <div id="keycode_lights"></div>
            <div id="keycode_txt"></div>
        </div>
        
        <script>
            let debug = document.getElementById("debug");
            function DEBUG(txt){
                debug.innerHTML = txt;
            }

            // event.key -> symbol
            var KEY_DEBUG_SET = [
                {"key":"x", "sym":"x"},
                {"key":"c", "sym":"c"},
                {"key": " ", "sym":"_"},
                {"key": "ArrowUp", "sym":"â†‘"}
            ]


            // debug keypress
            function addKeyLights(keyset){
                // remove the old lights
                let key_div = document.getElementById("keycode-debug");
                key_div.style.width = (keyset.length*22+2)+"px";
                let lights = document.getElementById("keycode_lights");
                let keys = document.getElementById("keycode_txt");
                lights.innerHTML = "";
                keys.innerHTML = "";

                // add the new lights for keypress activation
                for(let k=0;k<keyset.length;k++){
                    let light = document.createElement("div");
                    light.classList.add("keycode_light");
                    light.id = "kcl_"+(k+1);
                    light.innerHTML = "O";
                    lights.appendChild(light);

                    let key = document.createElement("div");
                    key.classList.add("keycode_txt");
                    key.id = "kct_"+(k+1);
                    key.innerHTML = keyset[k]["sym"];
                    keys.appendChild(key);
                }
            }

            // turn the light on for the specific keycode
            function lightOn(keycode){
                let light_idx = -1;
                for(let k=0;k<KEY_DEBUG_SET.length;k++){
                    if(KEY_DEBUG_SET[k]["key"] == keycode){
                        light_idx = k;
                        break;
                    }
                }
                if(light_idx != -1){
                    let light = document.getElementById("kcl_"+(light_idx+1));
                    light.classList.add("on");
                }
            }
            function lightOff(keycode){
                let light_idx = -1;
                for(let k=0;k<KEY_DEBUG_SET.length;k++){
                    if(KEY_DEBUG_SET[k]["key"] == keycode){
                        light_idx = k;
                        break;
                    }
                }
                if(light_idx != -1){
                    let light = document.getElementById("kcl_"+(light_idx+1));
                    light.classList.remove("on");
                }
            }

            
        </script>



        <!-- MOVE THIS TO SCRIPTS LATER WHEN IT'S FUNCTIONAL -->
        <script>
            

            // fake initial graph for testing the UI
            function fakeGraph(){
                CUR_NAME = "phd"
                CUR_CHAR = "@"
                CUR_NODES = ["idle","meme","code"]
                CUR_EDGES = {
                    "0-1":"step 10",
                    "1-0":"none",
                    "0-2":"nextTo c",
                    "2-2":"none",
                    "2-1": "within m",
                    "1-2": "none"
                }
                
            }

            // it's the initial function, init?
            function init(){
                fakeGraph();
                addCurGraphDivs();
                makeNodes();
                makeEdges();

                setInterval(renderGraph, 10);   //wait 10ms before rendering graph (to load the fonts)

                //add the lights
                addKeyLights(KEY_DEBUG_SET);
            }

            // main loop
            // function main(){
            //     requestAnimationFrame(main); 

            //     renderGraph();  //called already by the 
            // }
            // main();

            // debug keypress
            // window.addEventListener("keydown", function(e){ 
            //     if(e.keyCode == 191){  // ? key
            //         DEBUG(document.activeElement == document.getElementById("graph_canvas"));
            //     }
            // });


            // turn key lights on and off
            window.addEventListener("keydown", function(e){
                lightOn(e.key)
            });
            window.addEventListener("keyup", function(e){
                lightOff(e.key)
            });


        </script>
    </body>
</html>